name: è‡ªåŠ¨åˆ†é…AppID

on:
  issues:
    types: [labeled]

jobs:
  assign-appid:
    if: contains(github.event.label.name, 'approved')
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Extract repository URL from issue
      id: extract-repo
      run: |
        # ä»issue bodyä¸­æå–ä»“åº“é“¾æ¥
        REPO_URL=$(echo "${{ github.event.issue.body }}" | grep -oP 'https://github\.com/[^/]+/[^/\s]+' | head -1)
        echo "repository_url=$REPO_URL" >> $GITHUB_OUTPUT
        echo "Found repository: $REPO_URL"
        
    - name: Assign AppID and update registry
      run: |
        node << 'EOF'
        const fs = require('fs');
        const path = require('path');
        
        // è¯»å–å½“å‰æ³¨å†Œè¡¨
        const registryPath = 'registry.json';
        let registry;
        
        try {
          registry = JSON.parse(fs.readFileSync(registryPath, 'utf8'));
        } catch (error) {
          console.error('Error reading registry:', error);
          process.exit(1);
        }
        
        // è·å–ä»“åº“URLå’Œissueä¿¡æ¯
        const repositoryUrl = process.env.REPOSITORY_URL || '${{ steps.extract-repo.outputs.repository_url }}';
        const issueNumber = '${{ github.event.issue.number }}';
        const submittedBy = '${{ github.event.issue.user.login }}';
        const approvedBy = '${{ github.actor }}';
        const currentTime = new Date().toISOString();
        
        if (!repositoryUrl) {
          console.error('No repository URL found in issue');
          process.exit(1);
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨è¯¥ä»“åº“
        const existingPlugin = Object.values(registry.plugins || {}).find(
          plugin => plugin.repository === repositoryUrl
        );
        
        if (existingPlugin) {
          console.log('Plugin already exists with AppID:', existingPlugin.appId);
          process.exit(0);
        }
        
        // åˆ†é…æ–°çš„AppID
        const newAppId = String(registry.nextAppId || 1);
        
        // æ·»åŠ æ–°æ’ä»¶
        if (!registry.plugins) registry.plugins = {};
        
        registry.plugins[newAppId] = {
          appId: newAppId,
          repository: repositoryUrl,
          submittedBy: submittedBy,
          submittedAt: currentTime,
          status: 'approved',
          approvedBy: approvedBy,
          approvedAt: currentTime,
          issueNumber: parseInt(issueNumber)
        };
        
        // æ›´æ–°nextAppIdå’ŒlastUpdated
        registry.nextAppId = parseInt(newAppId) + 1;
        registry.lastUpdated = currentTime;
        
        // å†™å›æ–‡ä»¶
        fs.writeFileSync(registryPath, JSON.stringify(registry, null, 2));
        
        console.log(`Assigned AppID ${newAppId} to ${repositoryUrl}`);
        
        // è¾“å‡ºä¿¡æ¯ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        console.log(`::set-output name=app_id::${newAppId}`);
        console.log(`::set-output name=repository_url::${repositoryUrl}`);
        EOF
      env:
        REPOSITORY_URL: ${{ steps.extract-repo.outputs.repository_url }}
        
    - name: Commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add registry.json
        git commit -m "Auto-assign AppID for plugin submission #${{ github.event.issue.number }}"
        git push
        
    - name: Comment on issue
      uses: actions/github-script@v7
      with:
        script: |
          const appId = '${{ steps.assign-appid.outputs.app_id }}';
          const repoUrl = '${{ steps.assign-appid.outputs.repository_url }}';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ğŸ‰ æ’ä»¶å·²æˆåŠŸæ·»åŠ åˆ°å¸‚åœºï¼
            
**åˆ†é…çš„AppID**: \`${appId}\`
**ä»“åº“é“¾æ¥**: ${repoUrl}

æ’ä»¶ç°åœ¨å¯ä»¥åœ¨AI-IDEæ’ä»¶å¸‚åœºä¸­æ‰¾åˆ°ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡æœç´¢æˆ–æµè§ˆæ¥å‘ç°å’Œå®‰è£…ä½ çš„æ’ä»¶ã€‚

æ„Ÿè°¢ä½ çš„è´¡çŒ®ï¼ğŸš€`
          });
          
    - name: Close issue
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.update({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'closed',
            labels: ['plugin-submission', 'completed']
          });
